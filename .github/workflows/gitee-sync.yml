name: Sync from Gitee to GitHub

on:
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  schedule:
    # æ¯æœˆ2000åˆ†é’Ÿå…è´¹é¢åº¦ï¼Œå¯ä»¥æ ¹æ®æ‰§è¡Œæ—¶é•¿è°ƒæ•´é¢‘ç‡ã€‚
    # åœ¨ä¸œå…«åŒºçš„ 14:00, 22:00, 23:00, 24:00 è¿è¡Œ
    # å¯¹åº” UTC çš„ 06:00, 14:00, 15:00, 16:00
    - cron: '0 6,14,15,16 * * *'

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Get repository count
        id: set-matrix
        run: |
          # è·å–ä»“åº“æ•°é‡
          REPO_COUNT=$(yq e '.repositories | length' sync-config.yml)
          # åˆ›å»ºæ•°ç»„
          INDICES="["
          for ((i=0; i<$REPO_COUNT; i++)); do
            if [ $i -eq 0 ]; then
              INDICES="${INDICES}$i"
            else
              INDICES="${INDICES},$i"
            fi
          done
          INDICES="${INDICES}]"
          # æ„å»ºæœ€ç»ˆçš„ JSON
          echo "matrix={\"repository\":$INDICES}" >> $GITHUB_OUTPUT

  sync:
    needs: prepare
    strategy:
      matrix: ${{fromJson(needs.prepare.outputs.matrix)}}
      fail-fast: false  # æŸä¸ªä»“åº“åŒæ­¥å¤±è´¥ä¸å½±å“å…¶ä»–ä»“åº“
    runs-on: ubuntu-latest
    steps:
      - name: Sync from Gitee
        uses: actions/checkout@v3
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Load Configuration
        id: config
        run: |
          # è¯»å–é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šç´¢å¼•çš„ä»“åº“é…ç½®
          echo "æ­£åœ¨è¯»å–é…ç½®æ–‡ä»¶..."
          REPO_INDEX=${{ matrix.repository }}
          
          GITEE_REPO_URL=$(yq e ".repositories[$REPO_INDEX].gitee.repo_url" sync-config.yml)
          GITEE_BRANCH=$(yq e ".repositories[$REPO_INDEX].gitee.branch" sync-config.yml)
          GITHUB_REPO_NAME=$(yq e ".repositories[$REPO_INDEX].github.repo_name" sync-config.yml)
          GITHUB_BRANCH=$(yq e ".repositories[$REPO_INDEX].github.branch // .repositories[$REPO_INDEX].gitee.branch" sync-config.yml)
          GITHUB_PRIVATE=$(yq e ".repositories[$REPO_INDEX].github.private // false" sync-config.yml)
          SYNC_NAME=$(yq e ".repositories[$REPO_INDEX].name" sync-config.yml)
          
          # è®¾ç½®è¾“å‡ºå˜é‡
          echo "gitee_repo_url=$GITEE_REPO_URL" >> $GITHUB_OUTPUT
          echo "gitee_branch=$GITEE_BRANCH" >> $GITHUB_OUTPUT
          echo "github_repo_name=$GITHUB_REPO_NAME" >> $GITHUB_OUTPUT
          echo "github_branch=$GITHUB_BRANCH" >> $GITHUB_OUTPUT
          echo "github_private=$GITHUB_PRIVATE" >> $GITHUB_OUTPUT
          echo "sync_name=$SYNC_NAME" >> $GITHUB_OUTPUT

      - name: Check and Create Repository
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_REPO: ${{ steps.config.outputs.github_repo_name }}
          GITHUB_USER: ${{ github.repository_owner }}
          GITHUB_PRIVATE: ${{ steps.config.outputs.github_private }}
        run: |
          echo "ğŸ” æ­£åœ¨æ£€æŸ¥ GitHub ä»“åº“æ˜¯å¦å­˜åœ¨..."
          REPO_EXISTS=$(curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/repos/$GITHUB_USER/$GITHUB_REPO" | jq -r '.id // empty')
          
          if [ -z "$REPO_EXISTS" ]; then
            echo "ğŸ“¦ ä»“åº“ä¸å­˜åœ¨ï¼Œå¼€å§‹åˆ›å»ºæ–°ä»“åº“..."
            curl -X POST -H "Authorization: token $GH_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/user/repos \
              -d "{\"name\":\"$GITHUB_REPO\", \"private\":$GITHUB_PRIVATE}"
            echo "âœ¨ ä»“åº“åˆ›å»ºæˆåŠŸï¼"
          else
            echo "âœ… ä»“åº“å·²å­˜åœ¨ï¼Œæ£€æŸ¥å¹¶æ›´æ–°å¯è§æ€§è®¾ç½®..."
            # æ›´æ–°å·²å­˜åœ¨ä»“åº“çš„å¯è§æ€§
            curl -X PATCH -H "Authorization: token $GH_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$GITHUB_USER/$GITHUB_REPO" \
              -d "{\"private\":$GITHUB_PRIVATE}"
            echo "âœ¨ ä»“åº“å¯è§æ€§å·²æ›´æ–°ï¼"
          fi

      - name: Sync Repository
        env:
          GITEE_REPO_URL: ${{ steps.config.outputs.gitee_repo_url }}
          GITEE_BRANCH: ${{ steps.config.outputs.gitee_branch }}
          GITHUB_REPO: ${{ steps.config.outputs.github_repo_name }}
          GITHUB_BRANCH: ${{ steps.config.outputs.github_branch }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_USER: ${{ github.repository_owner }}
          GITEE_USERNAME: ${{ secrets.GITEE_USERNAME }}
          GITEE_PASSWORD: ${{ secrets.GITEE_PASSWORD }}
        run: |
          echo "ğŸ”§ é…ç½® Git ç”¨æˆ·ä¿¡æ¯..."
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          echo "ğŸ“¥ æ­£åœ¨å…‹éš† Gitee ä»“åº“çš„ ${GITEE_BRANCH} åˆ†æ”¯..."
          # æ„å»ºåŒ…å«è®¤è¯ä¿¡æ¯çš„ URL
          GITEE_AUTH_URL=$(echo "$GITEE_REPO_URL" | sed "s|https://|https://$GITEE_USERNAME:$GITEE_PASSWORD@|")
          if ! git clone -b "$GITEE_BRANCH" "$GITEE_AUTH_URL" temp; then
            echo "âŒ å…‹éš† Gitee ä»“åº“å¤±è´¥"
            exit 1
          fi
          
          echo "ğŸ“‹ æ£€æŸ¥ä»“åº“å†…å®¹..."
          if [ ! "$(ls -A temp)" ]; then
            echo "âŒ Gitee ä»“åº“ä¸ºç©º"
            rm -rf temp
            exit 1
          fi

          echo "ğŸ” è·å–æäº¤ä¿¡æ¯..."
          LAST_SYNC_COMMIT=$(git log --grep="Sync from Gitee" -1 --format="%B" | grep -oP "Gitee Commit: \K[a-f0-9]+") || true
          
          cd temp
          GITEE_LATEST_COMMIT=$(git rev-parse HEAD)
          cd ..
          
          echo "ğŸ“Š ä¸Šæ¬¡åŒæ­¥çš„æäº¤: ${LAST_SYNC_COMMIT:-æ— }"
          echo "ğŸ“Š Gitee æœ€æ–°æäº¤: ${GITEE_LATEST_COMMIT}"
          
          # if [ ! -z "$LAST_SYNC_COMMIT" ] && [ "$LAST_SYNC_COMMIT" = "$GITEE_LATEST_COMMIT" ]; then
          #   echo "âœ¨ æ— éœ€åŒæ­¥ï¼šGitee ä»“åº“æ— æ–°æ›´æ”¹"
          #   rm -rf temp
          #   exit 0
          # fi
          
          echo "ğŸ”„ æ£€æµ‹åˆ°æ›´æ”¹ï¼Œå¼€å§‹åŒæ­¥..."
          
          echo "ğŸ“‹ å‡†å¤‡å·¥ä½œç›®å½•..."
          WORK_DIR="sync_workspace"
          rm -rf $WORK_DIR
          mkdir -p $WORK_DIR
          
          echo "ğŸ“‹ å¤åˆ¶æ–‡ä»¶åˆ°å·¥ä½œç›®å½•..."
          cd temp
          shopt -s extglob
          cp -r !(*.git|.github) "../$WORK_DIR/"
          cd ..
          rm -rf temp
          
          echo "ğŸ”„ å‡†å¤‡æ¨é€ä»£ç ..."
          cd $WORK_DIR
          
          # åˆå§‹åŒ– git
          git init
          echo "ğŸ”„ å¼€å§‹å‡†å¤‡æ¨é€ä»£ç åˆ° GitHub..."
          
          git add .
          echo "âœ… å·²æ·»åŠ æ‰€æœ‰æ–‡ä»¶åˆ°æš‚å­˜åŒº"
          
          git commit -m "Sync from Gitee $(date '+%Y-%m-%d %H:%M:%S')
            Gitee Commit: ${GITEE_LATEST_COMMIT}"
          echo "âœ… å·²åˆ›å»ºæäº¤è®°å½•"
          
          # æ¨é€åˆ° GitHub
          echo "ğŸ”— æ­£åœ¨é…ç½® GitHub è¿œç¨‹ä»“åº“åœ°å€..."
          git remote add origin "https://$GH_TOKEN@github.com/$GITHUB_USER/$GITHUB_REPO.git"
          echo "âœ… è¿œç¨‹ä»“åº“é…ç½®å®Œæˆ"
          
          echo "ğŸŒ¿ æ­£åœ¨åˆ‡æ¢åˆ° ${GITHUB_BRANCH} åˆ†æ”¯..."
          git branch -M ${GITHUB_BRANCH}
          echo "âœ… åˆ†æ”¯åˆ‡æ¢å®Œæˆ"
          
          echo "â¬†ï¸ æ­£åœ¨æ¨é€ä»£ç åˆ° GitHub..."
          git push -f origin ${GITHUB_BRANCH}
          echo "ğŸ‰ ä»£ç æ¨é€å®Œæˆï¼"
          
          cd ..
          rm -rf $WORK_DIR 